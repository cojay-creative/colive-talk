<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colive Talk - OBS Overlay</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100vw;
            height: 100vh;
            background: transparent;
            font-family: 'Noto Sans KR', Arial, sans-serif;
            overflow: hidden;
        }
        
        .overlay-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: transparent;
            pointer-events: none;
            z-index: 9999;
        }
        
        .subtitle {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            font-size: 24px;
            font-weight: bold;
            padding: 16px 24px;
            border-radius: 8px;
            text-align: center;
            max-width: 80%;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            border: 2px solid rgba(255,255,255,0.3);
            line-height: 1.4;
            word-break: keep-all;
            white-space: pre-wrap;
            display: none;
        }
        
        .subtitle.show {
            display: block;
        }
        
        .debug-info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            color: #00ff00;
            font-size: 12px;
            font-family: monospace;
            padding: 10px;
            border-radius: 5px;
            max-width: 400px;
            max-height: 300px;
            overflow: auto;
            pointer-events: auto;
            z-index: 10000;
            display: none;
        }
        
        .debug-info.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="overlay-container">
        <div id="subtitle" class="subtitle">
            ì•ˆë…•í•˜ì„¸ìš”! ìŒì„±ì¸ì‹ì„ ì‹œì‘í•´ì£¼ì„¸ìš” ğŸ¤
        </div>
        
        <div id="debug" class="debug-info">
            <div style="margin-bottom: 10px; font-weight: bold;">DEBUG INFO</div>
            <div id="debug-content"></div>
        </div>
    </div>

    <script>
        console.log('ğŸ¬ OBS ì˜¤ë²„ë ˆì´ ì‹œì‘');
        
        let debugInfo = [];
        let adminSettings = {
            inactiveMessage: 'ì•ˆë…•í•˜ì„¸ìš”! ìŒì„±ì¸ì‹ì„ ì‹œì‘í•´ì£¼ì„¸ìš” ğŸ¤',
            listeningMessage: 'ìŒì„±ì„ ë“£ê³  ìˆìŠµë‹ˆë‹¤...',
            translatingMessage: 'ë²ˆì—­ ì¤‘...'
        };
        
        const subtitle = document.getElementById('subtitle');
        const debugDiv = document.getElementById('debug');
        const debugContent = document.getElementById('debug-content');
        
        // URL íŒŒë¼ë¯¸í„° í™•ì¸
        const params = new URLSearchParams(window.location.search);
        const showDebug = params.get('debug') === 'true';
        const sessionId = params.get('sessionId');
        
        if (showDebug) {
            debugDiv.classList.add('show');
        }
        
        function addDebugInfo(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.unshift(`[${timestamp}] ${message}`);
            debugInfo = debugInfo.slice(0, 20);
            
            if (debugContent) {
                debugContent.innerHTML = debugInfo
                    .map(info => `<div style="font-size: 10px; opacity: 0.8;">${info}</div>`)
                    .join('');
            }
            
            console.log('ğŸ” DEBUG:', message);
        }
        
        function updateSubtitle(data) {
            let displayText = '';
            
            if (data.translatedText) {
                displayText = data.translatedText;
                addDebugInfo(`ë²ˆì—­ í…ìŠ¤íŠ¸ í‘œì‹œ: ${data.translatedText}`);
            } else if (data.originalText) {
                displayText = data.originalText;
                addDebugInfo(`ì›ë³¸ í…ìŠ¤íŠ¸ í‘œì‹œ: ${data.originalText}`);
            } else if (!data.isListening) {
                displayText = adminSettings.inactiveMessage;
                addDebugInfo('ê´€ë¦¬ì ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ');
            } else {
                displayText = adminSettings.listeningMessage;
                addDebugInfo('ê´€ë¦¬ì ë“£ê¸° ë©”ì‹œì§€ í‘œì‹œ');
            }
            
            subtitle.textContent = displayText;
            subtitle.classList.add('show');
        }
        
        // ê´€ë¦¬ì ì„¤ì • ë¡œë“œ
        async function loadAdminSettings() {
            try {
                const response = await fetch('/api/admin-settings');
                if (response.ok) {
                    const result = await response.json();
                    adminSettings = result.settings;
                    addDebugInfo('ê´€ë¦¬ì ì„¤ì • ë¡œë“œ ì™„ë£Œ');
                }
            } catch (error) {
                addDebugInfo('ê´€ë¦¬ì ì„¤ì • ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©');
            }
        }
        
        // localStorage í´ë§
        function pollLocalStorage() {
            try {
                const stored = localStorage.getItem('subtitle_sync_data');
                if (stored) {
                    const data = JSON.parse(stored);
                    addDebugInfo(`localStorage: ì›ë³¸="${data.originalText}" ë²ˆì—­="${data.translatedText}"`);
                    updateSubtitle(data);
                    return true;
                }
            } catch (error) {
                addDebugInfo(`localStorage ì˜¤ë¥˜: ${error.message}`);
            }
            return false;
        }
        
        // PostMessage ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('message', (event) => {
            try {
                if (event.data && event.data.type === 'SUBTITLE_UPDATE') {
                    addDebugInfo(`PostMessage: ì›ë³¸="${event.data.originalText}" ë²ˆì—­="${event.data.translatedText}"`);
                    updateSubtitle(event.data);
                }
            } catch (error) {
                addDebugInfo(`PostMessage ì˜¤ë¥˜: ${error.message}`);
            }
        });
        
        // ì„œë²„ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (OBS ì „ìš©)
        async function pollServer() {
            try {
                if (!sessionId) {
                    addDebugInfo('ì„¸ì…˜ IDê°€ ì—†ì–´ì„œ API í˜¸ì¶œ ê±´ë„ˆëœ€');
                    return false;
                }
                
                // APIì—ì„œ ì‹¤ì‹œê°„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(`/api/subtitle-status?sessionId=${sessionId}`);
                if (response.ok) {
                    const result = await response.json();
                    const data = result.data;
                    
                    if (data && (data.originalText || data.translatedText)) {
                        addDebugInfo(`ì„œë²„ API: ì›ë³¸="${data.originalText}" ë²ˆì—­="${data.translatedText}"`);
                        updateSubtitle(data);
                        return true;
                    }
                }
            } catch (error) {
                addDebugInfo(`API ì˜¤ë¥˜: ${error.message}`);
            }
            return false;
        }
        
        // ë©€í‹°í”Œ ë™ê¸°í™” ì‹œë„ (API ìš°ì„ )
        async function syncData() {
            // 1. ì„œë²„ API ì‹œë„ (OBSì—ì„œ ê°€ì¥ ì•ˆì •ì )
            if (await pollServer()) return;
            
            // 2. localStorage ì‹œë„ (ë¸Œë¼ìš°ì € í™˜ê²½ìš©)
            if (pollLocalStorage()) return;
            
            // 3. PostMessageëŠ” ì´ë²¤íŠ¸ ê¸°ë°˜ì´ë¯€ë¡œ ë³„ë„ë¡œ ì²˜ë¦¬ë¨
        }
        
        // ì´ˆê¸°í™”
        addDebugInfo('ì˜¤ë²„ë ˆì´ ì´ˆê¸°í™” ì™„ë£Œ');
        addDebugInfo(`ë””ë²„ê·¸ ëª¨ë“œ: ${showDebug ? 'ON' : 'OFF'}`);
        addDebugInfo(`ì„¸ì…˜ ID: ${sessionId || 'ì—†ìŒ'}`);
        addDebugInfo('ë™ê¸°í™” ë°©ë²•: API + localStorage + PostMessage (API ìš°ì„ )');
        
        // ê´€ë¦¬ì ì„¤ì • ë¡œë“œ
        loadAdminSettings();
        
        // ì •ê¸°ì  ë™ê¸°í™” (200ms ê°„ê²©)
        setInterval(syncData, 200);
        
        // ì´ˆê¸° ë™ê¸°í™”
        syncData();
        
        subtitle.classList.add('show');
    </script>
</body>
</html>